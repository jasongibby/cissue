#!/usr/bin/env bash
set -euo pipefail

OWNER="aptive-env"
CACHE_TTL=300  # seconds (5 minutes)

# Parse flags
FORCE_REFRESH=0
GLOBAL=0
for arg in "$@"; do
  [[ "$arg" == "-r" || "$arg" == "--refresh" ]] && FORCE_REFRESH=1
  [[ "$arg" == "-g" || "$arg" == "--global" ]]  && GLOBAL=1
done

# Detect current repo (falls back to global if not in a git repo)
CURRENT_REPO=""
if [[ "$GLOBAL" -eq 0 ]]; then
  CURRENT_REPO=$(gh repo view --json name --jq .name 2>/dev/null || true)
fi

if [[ -n "$CURRENT_REPO" ]]; then
  CACHE_FILE="${HOME}/.cache/cissue-${CURRENT_REPO}.txt"
  SEARCH_SCOPE="repo:$OWNER/$CURRENT_REPO"
else
  CACHE_FILE="${HOME}/.cache/cissue-global.txt"
  SEARCH_SCOPE="org:$OWNER"
fi

fetch_and_cache() {
  echo "Fetching issues..." >&2
  GH_USER=$(gh api user --jq .login)
  gh api graphql -f query='
    query($search: String!) {
      search(query: $search, type: ISSUE, first: 100) {
        nodes {
          ... on Issue {
            number
            title
            projectItems(first: 5) {
              nodes {
                status: fieldValueByName(name: "Status") {
                  ... on ProjectV2ItemFieldSingleSelectValue { name }
                }
              }
            }
          }
        }
      }
    }
  ' -f search="assignee:$GH_USER state:open $SEARCH_SCOPE" \
  | jq -r '
      .data.search.nodes[]
      | (.projectItems.nodes[0].status.name // "No Status") as $s
      | (($s | explode | add // 0) % 6) as $idx
      | (["91","92","93","94","95","96"][$idx]) as $code
      | (($s | length) + 2) as $len
      | ([0, (15 - $len)] | max) as $pad
      | "\(.number)\t\u001b[\($code)m[\($s)]\(" " * $pad)\u001b[0m\t\(.title)"
    ' > "$CACHE_FILE"
}

# Use cache if fresh, otherwise fetch
if [[ "$FORCE_REFRESH" -eq 1 ]] || [[ ! -f "$CACHE_FILE" ]]; then
  fetch_and_cache
else
  cache_age=$(( $(date +%s) - $(stat -f %m "$CACHE_FILE") ))
  if [[ "$cache_age" -gt "$CACHE_TTL" ]]; then
    fetch_and_cache
  else
    echo "Using cached issues (${cache_age}s old, refresh with -r)..." >&2
  fi
fi

if [[ ! -s "$CACHE_FILE" ]]; then
  echo "No open issues found." >&2
  exit 0
fi

HEADER=$(
  figlet -f slant "cissue" | while IFS= read -r line; do
    printf '\033[36m%s\033[0m\n' "$line"
  done
  printf '\n\033[2m  Enter: copy issue #  │  Ctrl+o: launch Claude\033[0m'
)

if [[ -n "$CURRENT_REPO" ]]; then
  FOOTER=$'\033[2m  showing: \033[0m\033[1m'"$CURRENT_REPO"$'\033[0m\033[2m  │  -g for all issues  │  -r to refresh cache\033[0m'
else
  FOOTER=$'\033[2m  showing: \033[0m\033[1mall repos\033[0m\033[2m  │  -r to refresh cache\033[0m'
fi

result=$(fzf \
  --ansi \
  --delimiter=$'\t' \
  --with-nth=2.. \
  --bind='enter:become(echo "number:{1}")' \
  --bind='ctrl-o:become(echo "prompt:{1}")' \
  --header="$HEADER" \
  --header-first \
  --footer="$FOOTER" \
  --color=16 \
  --reverse \
  --no-sort < "$CACHE_FILE") || exit 0

action="${result%%:*}"
issue_num="${result#*:}"

if [ "$action" = "prompt" ]; then
  claude "Read GitHub issue #$issue_num in full — including the description, all comments, and any linked PRs. Understand the current state and what's already been tried. Then either continue where we left off or start fresh, beginning with a plan before writing any code."
else
  printf '%s' "$issue_num" | pbcopy
  echo "Copied #$issue_num to clipboard" >&2
fi
