#!/usr/bin/env bash
set -euo pipefail
umask 077

CONFIG_DIR="${HOME}/.config/cissue"
CONFIG_FILE="${CONFIG_DIR}/config"
CACHE_TTL=300  # seconds (5 minutes)

# Load config if it exists
if [[ -f "$CONFIG_FILE" ]]; then
  OWNER=$(grep '^OWNER=' "$CONFIG_FILE" | head -1 | cut -d= -f2 | tr -d '"')
fi

# Parse flags
FORCE_REFRESH=0
GLOBAL=0
SET_ORG=0
SHOW_HELP=0
INTERNAL_RELOAD=0
INTERNAL_HEADER=0
INTERNAL_TOGGLE=0
INTERNAL_FOOTER=0
for arg in "$@"; do
  [[ "$arg" == "-r" || "$arg" == "--refresh" ]] && FORCE_REFRESH=1
  [[ "$arg" == "-g" || "$arg" == "--global" ]]  && GLOBAL=1
  [[ "$arg" == "--set-org" ]]                    && SET_ORG=1
  [[ "$arg" == "--help" ]]                        && SHOW_HELP=1
  [[ "$arg" == "--_reload" ]]                     && INTERNAL_RELOAD=1
  [[ "$arg" == "--_header" ]]                     && INTERNAL_HEADER=1
  [[ "$arg" == "--_toggle" ]]                     && INTERNAL_TOGGLE=1
  [[ "$arg" == "--_footer" ]]                     && INTERNAL_FOOTER=1
done

# Internal: print header for fzf transform-header (no deps needed beyond figlet)
if [[ "$INTERNAL_HEADER" -eq 1 ]]; then
  figlet -f slant "cissue" | while IFS= read -r line; do
    printf '\033[36m%s\033[0m\n' "$line"
  done
  printf '\n\033[2m  Enter: copy issue #  │  Ctrl+o: Claude  │  Ctrl+r: refresh  │  Ctrl+g: toggle scope\033[0m'
  exit 0
fi

# Internal: print footer showing current scope
if [[ "$INTERNAL_FOOTER" -eq 1 ]]; then
  mode=$(cat "${TOGGLE_FILE:?}")
  if [[ "$mode" == "repo" ]]; then
    printf '\033[2m  showing: \033[0m\033[1m%s\033[0m\033[2m  │  Ctrl+g for all issues\033[0m' "${CURRENT_REPO:?}"
  else
    printf '\033[2m  showing: \033[0m\033[1mall repos\033[0m\033[2m  │  Ctrl+g for repo issues\033[0m'
  fi
  exit 0
fi

# Show help and exit
if [[ "$SHOW_HELP" -eq 1 ]]; then
  cat <<'HELP'
Usage: cissue [options]

Options:
  -g, --global      Show issues across all org repos (default: current repo)
  -r, --refresh     Force cache refresh
      --set-org     Change your GitHub org
      --help        Show this help message

Keybindings (in picker):
  Enter      Copy issue number to clipboard
  Ctrl+o     Open issue in Claude
  Ctrl+r     Refresh issue list
  Ctrl+g     Toggle repo/global scope
  Esc        Exit
HELP
  exit 0
fi

# Skip validation for internal fzf callbacks (already verified on initial run)
if [[ "$INTERNAL_RELOAD" -eq 0 && "$INTERNAL_TOGGLE" -eq 0 ]]; then

# Check dependencies
missing=()
for cmd in gh fzf figlet jq; do
  command -v "$cmd" &>/dev/null || missing+=("$cmd")
done
if [[ ${#missing[@]} -gt 0 ]]; then
  echo "Missing dependencies: ${missing[*]}" >&2
  echo "Install with: brew install ${missing[*]}" >&2
  exit 1
fi

if ! gh auth status &>/dev/null; then
  echo "Not logged in to GitHub. Run: gh auth login" >&2
  exit 1
fi

# Org setup
setup_org() {
  printf "Enter your GitHub org name: " >&2
  read -r org_name
  if [[ -z "$org_name" ]]; then
    echo "Org name cannot be empty." >&2
    exit 1
  fi
  if [[ ! "$org_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Invalid org name. Use only letters, numbers, hyphens, underscores." >&2
    exit 1
  fi
  mkdir -p "$CONFIG_DIR"
  echo "OWNER=\"$org_name\"" > "$CONFIG_FILE"
  OWNER="$org_name"
  echo "Org set to '$org_name'. Saved to $CONFIG_FILE" >&2
}

if [[ "$SET_ORG" -eq 1 ]]; then
  setup_org
  rm -f "${HOME}/.cache/cissue-"*.txt
  exit 0
fi

if [[ -z "${OWNER:-}" ]]; then
  echo "Welcome to cissue! Let's set up your GitHub org." >&2
  setup_org
fi

fi # end skip validation

# Detect current repo (falls back to global if not in a git repo)
# Internal callbacks pass these as env vars to skip the slow gh repo view call
if [[ -z "${CACHE_FILE:-}" ]]; then
  CURRENT_REPO=""
  if [[ "$GLOBAL" -eq 0 ]]; then
    CURRENT_REPO=$(gh repo view --json name --jq .name 2>/dev/null || true)
    CURRENT_REPO="${CURRENT_REPO//[^a-zA-Z0-9._-]/}"
  fi

  GLOBAL_CACHE="${HOME}/.cache/cissue-global.txt"
  GLOBAL_SCOPE="org:$OWNER"

  if [[ -n "$CURRENT_REPO" ]]; then
    REPO_CACHE="${HOME}/.cache/cissue-${CURRENT_REPO}.txt"
    REPO_SCOPE="repo:$OWNER/$CURRENT_REPO"
  fi

  if [[ -n "$CURRENT_REPO" && "$GLOBAL" -eq 0 ]]; then
    CACHE_FILE="$REPO_CACHE"
    SEARCH_SCOPE="$REPO_SCOPE"
  else
    CACHE_FILE="$GLOBAL_CACHE"
    SEARCH_SCOPE="$GLOBAL_SCOPE"
  fi
fi

fetch_and_cache() {
  echo "Fetching issues..." >&2
  GH_USER=$(gh api user --jq .login)
  gh api graphql -f query='
    query($search: String!) {
      search(query: $search, type: ISSUE, first: 100) {
        nodes {
          ... on Issue {
            number
            title
            projectItems(first: 5) {
              nodes {
                status: fieldValueByName(name: "Status") {
                  ... on ProjectV2ItemFieldSingleSelectValue { name }
                }
              }
            }
          }
        }
      }
    }
  ' -f search="assignee:$GH_USER state:open $SEARCH_SCOPE" \
  | jq -r '
      .data.search.nodes[]
      | (.projectItems.nodes[0].status.name // "No Status") as $s
      | (($s | explode | add // 0) % 6) as $idx
      | (["91","92","93","94","95","96"][$idx]) as $code
      | (($s | length) + 2) as $len
      | ([0, (15 - $len)] | max) as $pad
      | "\(.number)\t\u001b[\($code)m[\($s)]\(" " * $pad)\u001b[0m\t\(.title)"
    ' > "$CACHE_FILE"
}

# Internal: reload data for fzf reload action (skip dep/auth checks)
if [[ "$INTERNAL_RELOAD" -eq 1 ]]; then
  # If toggling is active, refresh whichever scope is current
  if [[ -n "${TOGGLE_FILE:-}" && -f "$TOGGLE_FILE" ]]; then
    mode=$(cat "$TOGGLE_FILE")
    if [[ "$mode" == "repo" ]]; then
      CACHE_FILE="${REPO_CACHE:?}"
      SEARCH_SCOPE="${REPO_SCOPE:?}"
    else
      CACHE_FILE="${GLOBAL_CACHE:?}"
      SEARCH_SCOPE="${GLOBAL_SCOPE:?}"
    fi
  fi
  fetch_and_cache
  cat "$CACHE_FILE"
  exit 0
fi

# Internal: toggle between repo and global scope
if [[ "$INTERNAL_TOGGLE" -eq 1 ]]; then
  if [[ -z "${REPO_CACHE:-}" ]]; then
    echo "No repo context to toggle to" >&2
    cat "${GLOBAL_CACHE:?}"
    exit 0
  fi
  mode=$(cat "${TOGGLE_FILE:?}")
  if [[ "$mode" == "repo" ]]; then
    CACHE_FILE="${GLOBAL_CACHE:?}"
    SEARCH_SCOPE="${GLOBAL_SCOPE:?}"
    echo "global" > "$TOGGLE_FILE"
  else
    CACHE_FILE="$REPO_CACHE"
    SEARCH_SCOPE="$REPO_SCOPE"
    echo "repo" > "$TOGGLE_FILE"
  fi
  # Use cache if fresh, otherwise fetch
  if [[ -f "$CACHE_FILE" ]]; then
    cache_age=$(( $(date +%s) - $(stat -f %m "$CACHE_FILE") ))
    if [[ "$cache_age" -gt "$CACHE_TTL" ]]; then
      fetch_and_cache
    fi
  else
    fetch_and_cache
  fi
  cat "$CACHE_FILE"
  exit 0
fi

print_header() {
  figlet -f slant "cissue" | while IFS= read -r line; do
    printf '\033[36m%s\033[0m\n' "$line"
  done
  printf '\n\033[2m  Enter: copy issue #  │  Ctrl+o: Claude  │  Ctrl+r: refresh  │  Ctrl+g: toggle scope\033[0m'
}

# Use cache if fresh, otherwise fetch
if [[ "$FORCE_REFRESH" -eq 1 ]] || [[ ! -f "$CACHE_FILE" ]]; then
  fetch_and_cache
else
  cache_age=$(( $(date +%s) - $(stat -f %m "$CACHE_FILE") ))
  if [[ "$cache_age" -gt "$CACHE_TTL" ]]; then
    fetch_and_cache
  else
    : # using cache silently
  fi
fi

if [[ ! -s "$CACHE_FILE" ]]; then
  echo "No open issues found." >&2
  exit 0
fi

HEADER=$(print_header)

# Track current mode for Ctrl+G toggling
TOGGLE_FILE=$(mktemp /tmp/cissue-mode.XXXXXX)
trap 'rm -f "$TOGGLE_FILE"' EXIT
if [[ -n "$CURRENT_REPO" && "$GLOBAL" -eq 0 ]]; then
  echo "repo" > "$TOGGLE_FILE"
  FOOTER=$'\033[2m  showing: \033[0m\033[1m'"$CURRENT_REPO"$'\033[0m\033[2m  │  Ctrl+g for all issues\033[0m'
else
  echo "global" > "$TOGGLE_FILE"
  FOOTER=$'\033[2m  showing: \033[0m\033[1mall repos\033[0m\033[2m  │  Ctrl+g for repo issues\033[0m'
fi

# Env vars passed to internal callbacks so they skip re-detection
TOGGLE_ENV="TOGGLE_FILE='$TOGGLE_FILE' CURRENT_REPO='${CURRENT_REPO:-}' CACHE_TTL='$CACHE_TTL' OWNER='$OWNER' REPO_CACHE='${REPO_CACHE:-}' REPO_SCOPE='${REPO_SCOPE:-}' GLOBAL_CACHE='$GLOBAL_CACHE' GLOBAL_SCOPE='$GLOBAL_SCOPE'"

result=$(fzf \
  --ansi \
  --delimiter=$'\t' \
  --with-nth=2.. \
  --bind='enter:become(echo "number:{1}")' \
  --bind='ctrl-o:become(echo "prompt:{1}")' \
  --bind="ctrl-r:transform-header(printf '  Refreshing...')+reload($TOGGLE_ENV $0 --_reload)+transform-header($0 --_header)" \
  --bind="ctrl-g:transform-header(printf '  Switching...')+reload($TOGGLE_ENV $0 --_toggle)+transform-header($0 --_header)+transform-footer($TOGGLE_ENV $0 --_footer)" \
  --header="$HEADER" \
  --header-first \
  --footer="$FOOTER" \
  --color=16 \
  --reverse \
  --no-sort < "$CACHE_FILE") || exit 0

action="${result%%:*}"
issue_num="${result#*:}"

if [ "$action" = "prompt" ]; then
  claude "Read GitHub issue #$issue_num in full — including the description, all comments, and any linked PRs. Understand the current state and what's already been tried. Then either continue where we left off or start fresh, beginning with a plan before writing any code."
else
  printf '%s' "$issue_num" | pbcopy
  echo "Copied #$issue_num to clipboard" >&2
fi
