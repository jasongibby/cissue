#!/usr/bin/env bash
set -euo pipefail
umask 077

CONFIG_DIR="${HOME}/.config/cissue"
CONFIG_FILE="${CONFIG_DIR}/config"
CACHE_TTL=300  # seconds (5 minutes)

# Load config if it exists
if [[ -f "$CONFIG_FILE" ]]; then
  OWNER=$(grep '^OWNER=' "$CONFIG_FILE" | head -1 | cut -d= -f2 | tr -d '"')
fi

# Parse flags
FORCE_REFRESH=0
GLOBAL=0
SET_ORG=0
SHOW_HELP=0
INTERNAL_RELOAD=0
for arg in "$@"; do
  [[ "$arg" == "-r" || "$arg" == "--refresh" ]] && FORCE_REFRESH=1
  [[ "$arg" == "-g" || "$arg" == "--global" ]]  && GLOBAL=1
  [[ "$arg" == "--set-org" ]]                    && SET_ORG=1
  [[ "$arg" == "--help" ]]                        && SHOW_HELP=1
  [[ "$arg" == "--_reload" ]]                     && INTERNAL_RELOAD=1
done

# Show help and exit
if [[ "$SHOW_HELP" -eq 1 ]]; then
  cat <<'HELP'
Usage: cissue [options]

Options:
  -g, --global      Show issues across all org repos (default: current repo)
  -r, --refresh     Force cache refresh
      --set-org     Change your GitHub org
      --help        Show this help message

Keybindings (in picker):
  Enter      Copy issue number to clipboard
  Ctrl+o     Open issue in Claude
  Ctrl+r     Refresh issue list
  Esc        Exit
HELP
  exit 0
fi

# Check dependencies
missing=()
for cmd in gh fzf figlet jq; do
  command -v "$cmd" &>/dev/null || missing+=("$cmd")
done
if [[ ${#missing[@]} -gt 0 ]]; then
  echo "Missing dependencies: ${missing[*]}" >&2
  echo "Install with: brew install ${missing[*]}" >&2
  exit 1
fi

if ! gh auth status &>/dev/null; then
  echo "Not logged in to GitHub. Run: gh auth login" >&2
  exit 1
fi

# Org setup
setup_org() {
  printf "Enter your GitHub org name: " >&2
  read -r org_name
  if [[ -z "$org_name" ]]; then
    echo "Org name cannot be empty." >&2
    exit 1
  fi
  if [[ ! "$org_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Invalid org name. Use only letters, numbers, hyphens, underscores." >&2
    exit 1
  fi
  mkdir -p "$CONFIG_DIR"
  echo "OWNER=\"$org_name\"" > "$CONFIG_FILE"
  OWNER="$org_name"
  echo "Org set to '$org_name'. Saved to $CONFIG_FILE" >&2
}

if [[ "$SET_ORG" -eq 1 ]]; then
  setup_org
  rm -f "${HOME}/.cache/cissue-"*.txt
  exit 0
fi

if [[ -z "${OWNER:-}" ]]; then
  echo "Welcome to cissue! Let's set up your GitHub org." >&2
  setup_org
fi

# Detect current repo (falls back to global if not in a git repo)
CURRENT_REPO=""
if [[ "$GLOBAL" -eq 0 ]]; then
  CURRENT_REPO=$(gh repo view --json name --jq .name 2>/dev/null || true)
  CURRENT_REPO="${CURRENT_REPO//[^a-zA-Z0-9._-]/}"
fi

if [[ -n "$CURRENT_REPO" ]]; then
  CACHE_FILE="${HOME}/.cache/cissue-${CURRENT_REPO}.txt"
  SEARCH_SCOPE="repo:$OWNER/$CURRENT_REPO"
else
  CACHE_FILE="${HOME}/.cache/cissue-global.txt"
  SEARCH_SCOPE="org:$OWNER"
fi

fetch_and_cache() {
  echo "Fetching issues..." >&2
  GH_USER=$(gh api user --jq .login)
  gh api graphql -f query='
    query($search: String!) {
      search(query: $search, type: ISSUE, first: 100) {
        nodes {
          ... on Issue {
            number
            title
            projectItems(first: 5) {
              nodes {
                status: fieldValueByName(name: "Status") {
                  ... on ProjectV2ItemFieldSingleSelectValue { name }
                }
              }
            }
          }
        }
      }
    }
  ' -f search="assignee:$GH_USER state:open $SEARCH_SCOPE" \
  | jq -r '
      .data.search.nodes[]
      | (.projectItems.nodes[0].status.name // "No Status") as $s
      | (($s | explode | add // 0) % 6) as $idx
      | (["91","92","93","94","95","96"][$idx]) as $code
      | (($s | length) + 2) as $len
      | ([0, (15 - $len)] | max) as $pad
      | "\(.number)\t\u001b[\($code)m[\($s)]\(" " * $pad)\u001b[0m\t\(.title)"
    ' > "$CACHE_FILE"
}

# Internal reload: fetch and output to stdout for fzf reload action
if [[ "$INTERNAL_RELOAD" -eq 1 ]]; then
  fetch_and_cache
  cat "$CACHE_FILE"
  exit 0
fi

# Use cache if fresh, otherwise fetch
if [[ "$FORCE_REFRESH" -eq 1 ]] || [[ ! -f "$CACHE_FILE" ]]; then
  fetch_and_cache
else
  cache_age=$(( $(date +%s) - $(stat -f %m "$CACHE_FILE") ))
  if [[ "$cache_age" -gt "$CACHE_TTL" ]]; then
    fetch_and_cache
  else
    : # using cache silently
  fi
fi

if [[ ! -s "$CACHE_FILE" ]]; then
  echo "No open issues found." >&2
  exit 0
fi

HEADER=$(
  figlet -f slant "cissue" | while IFS= read -r line; do
    printf '\033[36m%s\033[0m\n' "$line"
  done
  printf '\n\033[2m  Enter: copy issue #  │  Ctrl+o: launch Claude  │  Ctrl+r: refresh\033[0m'
)

if [[ -n "$CURRENT_REPO" ]]; then
  FOOTER=$'\033[2m  showing: \033[0m\033[1m'"$CURRENT_REPO"$'\033[0m\033[2m  │  -g for all issues  │  -r to refresh cache ('"${CACHE_TTL}"$'s ttl)\033[0m'
else
  FOOTER=$'\033[2m  showing: \033[0m\033[1mall repos\033[0m\033[2m  │  -r to refresh cache ('"${CACHE_TTL}"$'s ttl)\033[0m'
fi

result=$(fzf \
  --ansi \
  --delimiter=$'\t' \
  --with-nth=2.. \
  --bind='enter:become(echo "number:{1}")' \
  --bind='ctrl-o:become(echo "prompt:{1}")' \
  --bind="ctrl-r:reload($0 $([ "$GLOBAL" -eq 1 ] && echo '-g') --_reload)" \
  --header="$HEADER" \
  --header-first \
  --footer="$FOOTER" \
  --color=16 \
  --reverse \
  --no-sort < "$CACHE_FILE") || exit 0

action="${result%%:*}"
issue_num="${result#*:}"

if [ "$action" = "prompt" ]; then
  claude "Read GitHub issue #$issue_num in full — including the description, all comments, and any linked PRs. Understand the current state and what's already been tried. Then either continue where we left off or start fresh, beginning with a plan before writing any code."
else
  printf '%s' "$issue_num" | pbcopy
  echo "Copied #$issue_num to clipboard" >&2
fi
